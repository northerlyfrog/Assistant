{"version":3,"sources":["../src/diagramControl.js"],"names":["getColorForValue","data","value","console","info","debug","i","thresholds","length","colorMap","_","first","getColorByXPercentage","canvas","xPercent","x","width","context","getContext","p","getImageData","color","TimeSeries","kbn","MetricsPanelCtrl","diagramEditor","displayEditor","panelDefaults","seriesOverrides","colors","legend","show","min","max","avg","current","total","gradient","enabled","maxDataPoints","mappingType","maxWidth","nullPointMode","format","valueName","valueOptions","valueMaps","op","text","content","init","logLevel","cloneCssStyles","startOnLoad","arrowMarkerAbsolute","flowchart","htmlLabels","useMaxWidth","sequenceDiagram","diagramMarginX","diagramMarginY","actorMargin","height","boxMargin","boxTextMargin","noteMargin","messageMargin","mirrorActors","bottomMarginAdj","gantt","titleTopMargin","barHeight","barGap","topPadding","leftPadding","gridLineStartPadding","fontSize","fontFamily","numberSectionStyles","DiagramCtrl","$scope","$injector","$sce","defaults","panel","graphId","id","containerDivId","events","on","onInitEditMode","bind","onDataReceived","unitFormats","getUnitFormats","initializeMermaid","mermaidAPI","initialize","parseError","handleParseError","err","hash","error","errorText","trustAsHtml","addEditorTab","$","document","getElementById","dataList","series","map","seriesHandler","setValues","updateDiagram","svgData","render","seriesData","datapoints","alias","target","replace","unit","flotpairs","getFlotPairs","override","push","without","thresholdCount","colorCount","refresh","colorIndex","splice","subItem","remove","svg","clearDiagram","graphDefinition","templateSrv","diagramType","detectType","diagramContainer","renderCallback","svgCode","bindFunctions","html","seriesItem","applyOverrides","lastPoint","last","lastValue","isArray","valueRounded","valueFormated","isString","escape","stats","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","valueFormatted","decimals","scaledDecimals","roundValue","getGradientForValue","colorData","Math","apply","absoluteDistance","valueDistanceFromMin","invertColors","seriesItemAlias","overrides","regex","stringToJsRegex","matches","match","split","strVale","Number","trim","slice","reverse","isNumber","delta","dec","floor","log","LN10","magn","pow","norm","size","result","scope","elem","attrs","ctrl","diagramElement","find","append","css","gradientValueMax","gradientValueMin","setElementHeight","updateCanvasStyle","updateStyle","clientWidth","canvasContext","clearRect","grd","createLinearGradient","colorWidth","currentColor","addColorStop","fillStyle","fillRect","innerText","renderingCompleted","undefined","key","targetElement","d3","select","selectAll","style","div","fo","attr","classed","parents","edgeElement","parent","addClass","dElement","warn","templateUrl"],"mappings":"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","file":"diagramControl.js","sourcesContent":["import './libs/mermaid/dist/mermaidAPI';\r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {diagramEditor, displayEditor} from './properties';\r\nimport _ from 'lodash';\r\nimport './series_overrides_diagram_ctrl';\r\nimport './css/diagram.css!'\r\n\r\nconst panelDefaults = {\r\n\t// other style overrides\r\n    seriesOverrides: [],\r\n\tthresholds: '0,10',\r\n\tcolors: ['rgba(50, 172, 45, 0.97)', 'rgba(237, 129, 40, 0.89)', 'rgba(245, 54, 54, 0.9)'],\r\n\tlegend: {\r\n\t\tshow: true,\r\n\t\tmin: true,\r\n\t\tmax: true,\r\n\t\tavg: true,\r\n\t\tcurrent: true,\r\n\t\ttotal: true,\r\n\t\tgradient: {\r\n\t\t\tenabled: true,\r\n\t\t\tshow: true\r\n\t\t}\r\n\t},\r\n\tmaxDataPoints: 100,\r\n\tmappingType: 1,\r\n\tmaxWidth: false,\r\n\tnullPointMode: 'connected',\r\n\tformat: 'none',\r\n\tvalueName: 'avg',\r\n\tvalueOptions: ['avg', 'min', 'max', 'total', 'current'],\r\n    valueMaps: [\r\n      { value: 'null', op: '=', text: 'N/A' }\r\n    ],\r\n    content: 'graph LR\\n' +\r\n\t\t'A[Square Rect] -- Link text --> B((Circle))\\n' +\r\n\t\t'A --> C(Round Rect)\\n' +\r\n\t\t'B --> D{Rhombus}\\n' +\r\n\t\t'C --> D\\n',\r\n\tinit: {\r\n\t\tlogLevel: 3, //1:debug, 2:info, 3:warn, 4:error, 5:fatal\r\n    \tcloneCssStyles: false, // - This options controls whether or not the css rules should be copied into the generated svg\r\n\t\tstartOnLoad: false, // - This options controls whether or mermaid starts when the page loads\r\n\t\tarrowMarkerAbsolute: true, // - This options controls whether or arrow markers in html code will be absolute paths or an anchor, #. This matters if you are using base tag settings.\r\n\t\tflowchart: {\r\n\t\t\thtmlLabels: true,\r\n\t\t\tuseMaxWidth: true\r\n\t\t},\r\n\t\tsequenceDiagram: {\r\n\t\t\tdiagramMarginX: 50, // - margin to the right and left of the sequence diagram\r\n\t\t\tdiagramMarginY: 10, // - margin to the over and under the sequence diagram\r\n\t\t\tactorMargin: 50, // - Margin between actors\r\n\t\t\twidth: 150, // - Width of actor boxes\r\n\t\t\theight: 65, // - Height of actor boxes00000000001111\r\n\t\t\tboxMargin: 10, // - Margin around l01oop boxes\r\n\t\t\tboxTextMargin: 5, // - margin around the text in loop/alt/opt boxes\r\n\t\t\tnoteMargin: 10, // - margin around notes\r\n\t\t\tmessageMargin: 35, // - Space between messages\r\n\t\t\tmirrorActors: true, // - mirror actors under diagram\r\n\t\t\tbottomMarginAdj: 1, // - Depending on css styling this might need adjustment. Prolongs the edge of the diagram downwards\r\n\t\t\tuseMaxWidth: true, // - when this flag is set the height and width is set to 100% and is then scaling with the available space if not the absolute space required is used\r\n\t\t},\r\n\t\tgantt: {\r\n\t\t\ttitleTopMargin: 25, // - margin top for the text over the gantt diagram\r\n\t\t\tbarHeight: 20, // - the height of the bars in the graph\r\n\t\t\tbarGap: 4, // - the margin between the different activities in the gantt diagram\r\n\t\t\ttopPadding: 50, // - margin between title and gantt diagram and between axis and gantt diagram.\r\n\t\t\tleftPadding: 75, // - the space allocated for the section name to the left of the activities.\r\n\t\t\tgridLineStartPadding: 35, // - Vertical starting position of the grid lines\r\n\t\t\tfontSize: 11, // - font size ...\r\n\t\t\tfontFamily: '\"Open-Sans\", \"sans-serif\"', // - font family ...\r\n\t\t\tnumberSectionStyles: 3, // - the number of alternating section styles\r\n\t\t\t/** axisFormatter: // - formatting of the axis, this might need adjustment to match your locale and preferences\r\n\t\t\t\t[\r\n\t\t        // Within a day\r\n\t\t        ['%I:%M', function (d) {\r\n\t\t            return d.getHours();\r\n\t\t        }],\r\n\t\t        // Monday a week\r\n\t\t        ['w. %U', function (d) {\r\n\t\t            return d.getDay() == 1;\r\n\t\t        }],\r\n\t\t        // Day within a week (not monday)\r\n\t\t        ['%a %d', function (d) {\r\n\t\t            return d.getDay() && d.getDate() != 1;\r\n\t\t        }],\r\n\t\t        // within a month\r\n\t\t        ['%b %d', function (d) {\r\n\t\t            return d.getDate() != 1;\r\n\t\t        }],\r\n\t\t        // Month\r\n\t\t        ['%m-%y', function (d) {\r\n\t\t            return d.getMonth();\r\n\t\t        }]] **/\r\n\t\t},\r\n\t\t//classDiagram: {},\r\n    \t//info: {}\r\n\t}\r\n};\r\n\r\nclass DiagramCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $sce) {\r\n\t\tsuper($scope, $injector);\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n\t\t\r\n\t\tthis.panel.graphId = 'diagram_' + this.panel.id;\r\n\t\tthis.containerDivId = 'container_'+this.panel.graphId;\r\n\t\tthis.$sce = $sce;\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\t\tthis.unitFormats = kbn.getUnitFormats();\r\n\t\tthis.initializeMermaid();\r\n\t}\r\n\t\r\n\tinitializeMermaid(){\r\n\t\tmermaidAPI.initialize(this.panel.init);\r\n\t\tmermaidAPI.parseError = this.handleParseError.bind(this);\r\n\t}\r\n\t\r\n\thandleParseError(err, hash){\r\n\t\tthis.error = 'Failed to parse diagram definition';\r\n\t\tthis.errorText = this.$sce.trustAsHtml('<p>Diagram Definition:</p><pre>' + err + '</pre>');\r\n\t}\r\n\t\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Diagram', diagramEditor, 2);\r\n\t\tthis.addEditorTab('Display', displayEditor, 3);\r\n\t}\r\n\t\r\n\tgetDiagramContainer(){\r\n\t\treturn $(document.getElementById(this.containerDivId));\r\n\t}\r\n\t\r\n\tonDataReceived(dataList){\r\n\t\tconsole.info('received data');\r\n\t\tconsole.debug(dataList);\r\n\t\tthis.series = dataList.map(this.seriesHandler.bind(this));\r\n\t\tconsole.info('mapped dataList to series');\r\n\t\tconsole.debug(this.series);\r\n\r\n\t\tvar data = {};\r\n\t\tthis.setValues(data);\r\n\t\tthis.updateDiagram(data);\r\n\t\tthis.svgData = data;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tseriesHandler(seriesData) {\r\n\t\tvar series = new TimeSeries({\r\n\t\t\tdatapoints: seriesData.datapoints,\r\n\t\t\talias: seriesData.target.replace(/\"|,|;|=|:|{|}/g, '_'),\r\n      \t\tunit: seriesData.unit\r\n\t\t});\r\n\t    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n\t    return series;\r\n\t} // End seriesHandler()\r\n\t\r\n\taddSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides.push(override || {});\r\n\t}\r\n\r\n\tremoveSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\r\n\t    this.render();\r\n\t}\r\n\t\r\n\tupdateThresholds(){\r\n\t\tvar thresholdCount = this.panel.thresholds.length;\r\n\t\tvar colorCount = this.panel.colors.length;\r\n\t\tthis.refresh();\r\n\t}\r\n\t\r\n\tchangeColor(colorIndex, color){\r\n\t\tthis.panel.colors[colorIndex] = color;\r\n\t}\r\n\t\r\n\tremoveColor(colorIndex){\r\n\t\tthis.panel.colors.splice(colorIndex,1);\r\n\t}\r\n\t\r\n\taddColor(){\r\n\t\tthis.panel.colors.push('rgba(255, 255, 255, 1)');\r\n\t}\r\n\t\r\n\tsetUnitFormat(subItem) {\r\n\t\tthis.panel.format = subItem.value;\r\n\t\tthis.render();\r\n\t}\r\n\t\r\n\tclearDiagram(){\r\n\t\t$('#'+this.panel.graphId).remove();\r\n\t\tthis.svg = {};\r\n\t}\r\n\r\n\tupdateDiagram(data){\r\n\t\tif(this.panel.content.length > 0){\r\n\t\t\tthis.clearDiagram();\r\n\t\t\tvar graphDefinition = this.panel.content;\r\n\t\t\tgraphDefinition = this.templateSrv.replace(graphDefinition);\r\n\t\t\tthis.diagramType = mermaidAPI.detectType(graphDefinition);\r\n\t\t\tvar diagramContainer = $(document.getElementById(this.containerDivId));\r\n\t\t    \r\n\t\t\tvar renderCallback = function (svgCode, bindFunctions){\r\n\t\t\t\tif(svgCode == '') {\r\n\t\t\t\t\tdiagramContainer.html('There was a problem rendering the graph');\r\n\t\t\t\t} else {\r\n\t\t\t    \tdiagramContainer.html(svgCode);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\t// if parsing the graph definition fails, the error handler will be called but the renderCallback() may also still be called.\r\n\t\t\tmermaidAPI.render(this.panel.graphId, graphDefinition, renderCallback);\r\n\t\t}\r\n\t} // End updateDiagram()\r\n\t\r\n\tsetValues(data) {\r\n\t    if (this.series && this.series.length > 0) {\r\n\t\t\tfor(var i = 0; i < this.series.length; i++){\r\n\t\t\t\tvar seriesItem = this.series[i];\r\n\t\t\t\tconsole.debug('setting values for series');\r\n\t\t\t\tconsole.debug(seriesItem);\r\n\t\t\t\tdata[seriesItem.alias] = this.applyOverrides(seriesItem.alias);\r\n\t\t\t\tvar lastPoint = _.last(seriesItem.datapoints);\r\n\t\t\t    var lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\r\n\t\t\t\r\n\t\t\t\tif (this.panel.valueName === 'name') {\r\n\t\t\t\t\tdata[seriesItem.alias].value = 0;\r\n\t\t\t        data[seriesItem.alias].valueRounded = 0;\r\n\t\t\t        data[seriesItem.alias].valueFormated = seriesItem.alias;\r\n\t\t\t\t} else if (_.isString(lastValue)) {\r\n\t\t\t        data[seriesItem.alias].value = 0;\r\n\t\t\t        data[seriesItem.alias].valueFormated = _.escape(lastValue);\r\n\t\t\t        data[seriesItem.alias].valueRounded = 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdata[seriesItem.alias].value = seriesItem.stats[data[seriesItem.alias].valueName];\r\n\t\t\t        //data[seriesItem.alias].flotpairs = seriesItem.flotpairs;\r\n\t\t\t\r\n\t\t\t        var decimalInfo = this.getDecimalsForValue(data[seriesItem.alias].value);\r\n\t\t\t        var formatFunc = kbn.valueFormats[this.panel.format];\r\n\t\t\t        data[seriesItem.alias].valueFormatted = formatFunc(data[seriesItem.alias].value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n\t\t\t        data[seriesItem.alias].valueRounded = kbn.roundValue(data[seriesItem.alias].value, decimalInfo.decimals);\r\n\t\t\t\t}\r\n\t\t\t\tif (this.panel.legend.gradient.enabled){\r\n\t\t\t\t\tdata[seriesItem.alias].color = this.getGradientForValue(data[seriesItem.alias].colorData, data[seriesItem.alias].value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdata[seriesItem.alias].color = getColorForValue(data[seriesItem.alias].colorData, data[seriesItem.alias].value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t    }\r\n\t} // End setValues()\r\n\t\r\n\tgetGradientForValue(data, value){\r\n\t\tconsole.info('Getting gradient for value');\r\n\t\tconsole.debug(data);\r\n\t\tconsole.debug(value);\r\n\t\tvar min = Math.min.apply(Math, data.thresholds);\r\n\t\tvar max = Math.max.apply(Math, data.thresholds);\r\n\t\tvar absoluteDistance = max - min;\r\n\t\tvar valueDistanceFromMin = value - min;\r\n\t\tvar xPercent = valueDistanceFromMin/absoluteDistance;\r\n\t\t// Get the smaller number to clamp at 0.999 max\r\n\t\txPercent = Math.min(0.999, xPercent);\r\n\t\t// Get the larger number to clamp at 0.001 min\r\n\t\txPercent = Math.max(0.001, xPercent);\r\n\t\tif(data.invertColors){\r\n\t\t\txPercent = 1-xPercent;\r\n\t\t}\r\n\t\t\r\n\t\treturn getColorByXPercentage(this.canvas, xPercent);\r\n\t}\r\n\t\r\n\tapplyOverrides(seriesItemAlias){\r\n\t\tvar seriesItem = {}, colorData = {}, overrides = {};\r\n\t\tconsole.info('applying overrides for seriesItem');\r\n\t\tconsole.debug(seriesItemAlias);\r\n\t\tconsole.debug(this.panel.seriesOverrides);\r\n\t\tfor(var i=0; i<=this.panel.seriesOverrides.length; i++){\r\n\t\t\tconsole.debug('comparing:');\r\n\t\t\tconsole.debug(this.panel.seriesOverrides[i]);\r\n\t\t\t\r\n\t\t\tif (this.panel.seriesOverrides[i]){\r\n\t\t\t\tvar regex = kbn.stringToJsRegex(this.panel.seriesOverrides[i].alias);\r\n\t\t\t\tvar matches = seriesItemAlias.match(regex);\r\n\t\t\t\tif(matches && matches.length > 0){\r\n\t\t\t\t\toverrides = this.panel.seriesOverrides[i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tcolorData.thresholds = (overrides.thresholds || this.panel.thresholds).split(',').map(function(strVale) {\r\n\t\t\treturn Number(strVale.trim());\r\n\t\t});\r\n\t\tcolorData.colorMap = this.panel.colors.slice();\r\n\t\tcolorData.invertColors = overrides.invertColors || false;\r\n\t\tif(colorData.invertColors){\r\n\t\t\tcolorData.colorMap.reverse();\r\n\t\t}\r\n\t\tseriesItem.colorData = colorData;\r\n\t\t\r\n\t\tseriesItem.valueName = overrides.valueName || this.panel.valueName;\r\n\t\t\r\n\t\treturn seriesItem;\r\n\t}\r\n\t\r\n\tinvertColorOrder() {\r\n\t    this.panel.colors.reverse();\r\n\t    this.refresh();\r\n\t}\r\n\r\n\tgetDecimalsForValue(value) {\r\n\t    if (_.isNumber(this.panel.decimals)) {\r\n\t      return {decimals: this.panel.decimals, scaledDecimals: null};\r\n\t    }\r\n\r\n\t    var delta = value / 2;\r\n\t    var dec = -Math.floor(Math.log(delta) / Math.LN10);\r\n\t\r\n\t    var magn = Math.pow(10, -dec),\r\n\t      norm = delta / magn, // norm is between 1.0 and 10.0\r\n\t      size;\r\n\t\r\n\t    if (norm < 1.5) {\r\n\t      size = 1;\r\n\t    } else if (norm < 3) {\r\n\t      size = 2;\r\n\t      // special case for 2.5, requires an extra decimal\r\n\t      if (norm > 2.25) {\r\n\t        size = 2.5;\r\n\t        ++dec;\r\n\t      }\r\n\t    } else if (norm < 7.5) {\r\n\t      size = 5;\r\n\t    } else {\r\n\t      size = 10;\r\n\t    }\r\n\t\r\n\t    size *= magn;\r\n\t\r\n\t    // reduce starting decimals if not needed\r\n\t    if (Math.floor(value) === value) { dec = 0; }\r\n\t\r\n\t    var result = {};\r\n\t    result.decimals = Math.max(0, dec);\r\n\t    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\t\r\n\t    return result;\r\n\t}\r\n\t\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tvar templateSrv = this.templateSrv;\r\n\t\tvar diagramElement = elem.find('.diagram');\r\n\t\tdiagramElement.append('<div id=\"'+ctrl.containerDivId+'\"></div>');\r\n\t    var diagramContainer = $(document.getElementById(ctrl.containerDivId));\r\n    \tconsole.debug('found diagramContainer');\r\n    \tconsole.debug(diagramContainer);\r\n    \telem.css('height', ctrl.height + 'px');\r\n    \t\r\n\t    var canvas = elem.find('.canvas')[0];\r\n\t    ctrl.canvas = canvas;\r\n\t    var gradientValueMax = elem.find('.gradient-value-max')[0];\r\n\t    var gradientValueMin = elem.find('.gradient-value-min')[0];\r\n    \t\r\n    \tfunction render(){\r\n    \t\tsetElementHeight();\r\n    \t\tupdateCanvasStyle();\r\n    \t\tupdateStyle();\r\n    \t}\r\n    \t\r\n    \tfunction updateCanvasStyle(){\r\n\t    \tcanvas.width = Math.max(diagramElement[0].clientWidth, 100);\r\n\t\t\tvar canvasContext = canvas.getContext(\"2d\");\r\n\t\t\tcanvasContext.clearRect(0, 0, canvas.width, canvas.height);\r\n\t\t\t\r\n\t\t\tvar grd = canvasContext.createLinearGradient(0, 0, canvas.width, 0);\r\n\t\t\tvar colorWidth = 1 / Math.max(ctrl.panel.colors.length, 1);\r\n\t\t\tfor(var i=0; i<ctrl.panel.colors.length; i++){\r\n\t\t\t\tvar currentColor = ctrl.panel.colors[i];\r\n\t\t\t\tgrd.addColorStop(Math.min(colorWidth*i,1), currentColor);\r\n\t\t\t}\r\n\t\t\tcanvasContext.fillStyle = grd;\r\n\t\t\tcanvasContext.fillRect(0, 0, canvas.width, 3);\r\n    \t\tctrl.canvasContext = canvasContext;\r\n    \t\t\r\n\t\t\tgradientValueMax.innerText = Math.max.apply(Math, ctrl.panel.thresholds.split(','));\r\n\t\t\tgradientValueMin.innerText = Math.min.apply(Math, ctrl.panel.thresholds.split(','));\r\n    \t}\r\n    \t\r\n\r\n    \t\r\n    \tfunction setElementHeight() {\r\n\t      //diagramContainer.css('height', ctrl.height + 'px');\r\n\t    }\r\n    \t\r\n    \tthis.events.on('render', function() {\r\n\t\t\trender();\r\n\t\t\tctrl.renderingCompleted();\r\n\t    });\r\n\t    \r\n\t    function updateStyle(){\r\n\t    \tvar data = ctrl.svgData;\r\n\t    \tctrl.svgData = {}; // get rid of the data after consuming it. This prevents adding duplicate DOM elements\r\n\t\t\tconsole.info('updating svg style');\r\n\t\t\tvar svg = $(document.getElementById(ctrl.panel.graphId));\r\n\t\t\t$(svg).css('min-width', $(svg).css('max-width')); \r\n\t\t\tif (ctrl.panel.maxWidth){\r\n\t\t\t\t$(svg).css('max-width', '100%');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(svg[0] === undefined){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor(var key in data){\r\n\t\t\t\tvar seriesItem = data[key];\r\n\t\t\t\t\r\n\t\t\t\t// Find nodes by ID if we can\r\n\t\t\t\tconsole.info('finding targetElement');\r\n\t\t\t\tvar targetElement = d3.select(svg[0].getElementById(key)); // $(svg).find('#'+key).first(); // jquery doesnt work for some ID expressions [prometheus data]\r\n\t\t\t\t\r\n\t\t\t\tif(targetElement[0][0] !== null){ // probably a flowchart\r\n\t\t\t\t\ttargetElement.selectAll('rect,circle,poly').style('fill', seriesItem.color);\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar div = targetElement.select('div');\r\n\t\t\t\t\tvar fo = targetElement.select('foreignObject');\r\n\t\t\t\t\t// make foreign object element taller to accomdate value in FireFox/IE\r\n\t\t\t\t\tfo.attr('height', 45);\r\n\t\t\t\t\t// Add value text\r\n\t\t\t\t\tvar p = div.append('p');\r\n\t\t\t\t\tp.classed('diagram-value');\r\n\t\t\t\t\tp.style('background-color', seriesItem.color);\r\n\t\t\t\t\tp.html(seriesItem.valueFormatted);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.debug('finding element that contains text node: ' + key);\r\n\t\t\t\t\ttargetElement = $(svg).find('div:contains(\"'+key+'\")'); // maybe a flowchart with an alias text node\r\n\t\t\t\t\tif(targetElement.length > 0){\r\n\t\t\t\t\t\ttargetElement.parents('.node').find('rect, circle, poly').css('fill', seriesItem.color);\r\n\t\t\t\t\t\t// make foreign object element taller to accomdate value in FireFox/IE\r\n\t\t\t\t\t\ttargetElement.parents('.node').find('foreignObject').attr('height', 45);\r\n\t\t\t\t\t\t// for edge matches\r\n\t\t\t\t\t\tvar edgeElement = targetElement.parent().find('.edgeLabel');\r\n\t\t\t\t\t\tif(edgeElement.length > 0){\r\n\t\t\t\t\t\t\tedgeElement.css('background-color', 'transparent');\r\n\t\t\t\t\t\t\tedgeElement.append('<br/>'+seriesItem.valueFormatted).addClass('diagram-value');\r\n\t\t\t\t\t\t\tedgeElement.parent('div').css('text-align', 'center').css('background-color', seriesItem.color);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvar dElement = d3.select(targetElement[0]);\r\n\t\t\t\t\t\t\t// Add value text\r\n\t\t\t\t\t\t\tvar p = dElement.append('p');\r\n\t\t\t\t\t\t\tp.classed('diagram-value');\r\n\t\t\t\t\t\t\tp.style('background-color', seriesItem.color);\r\n\t\t\t\t\t\t\tp.html(seriesItem.valueFormatted);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttargetElement = $(svg).find('text:contains(\"'+key+'\")'); // sequence diagram, gantt ?\r\n\t\t\t\t\t\tif(targetElement.length == 0){\r\n\t\t\t\t\t\t\tconsole.warn('couldnt not find a diagram node with id/text: ' + key);\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// for node matches\r\n\t\t\t\t\t\ttargetElement.parent().find('rect, circle, poly').css('fill', seriesItem.color);\r\n\t\t\t\t\t\ttargetElement.append('\\n' + seriesItem.valueFormatted);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconsole.debug(targetElement);\r\n\t\t\t\tconsole.info('set nodes:' + key + ' to color:' + seriesItem.color);\r\n\t\t\t}\r\n\t\t\t//return $(svg).html();\r\n\t\t} // End updateStyle()\r\n\t}\r\n// End Class\r\n}\r\n\r\nfunction getColorForValue(data, value) {\r\n\tconsole.info('Getting color for value');\r\n\tconsole.debug(data);\r\n\tconsole.debug(value);\r\n\tfor (var i = data.thresholds.length; i > 0; i--) {\r\n\t\tif (value >= data.thresholds[i-1]) {\r\n\t\treturn data.colorMap[i];\r\n\t}\r\n  }\r\n  return _.first(data.colorMap);\r\n}\r\n\r\nfunction getColorByXPercentage(canvas, xPercent){\r\n\tvar x = canvas.width * xPercent;\r\n\tvar context = canvas.getContext(\"2d\");\r\n    var p = context.getImageData(x, 1, 1, 1).data; \r\n    var color = 'rgba('+[p[0] +','+ p[1] +','+ p[2] +','+ p[3]]+')';\r\n    return color;\r\n}\r\n\r\nDiagramCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n\tDiagramCtrl,\r\n\tDiagramCtrl as MetricsPanelCtrl\r\n};"]}